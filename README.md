# Timer è®¡æ—¶å™¨ç³»ç»Ÿ
[![zread](https://img.shields.io/badge/Ask_Zread-_.svg?style=flat&color=00b0aa&labelColor=000000&logo=data%3Aimage%2Fsvg%2Bxml%3Bbase64%2CPHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTQuOTYxNTYgMS42MDAxSDIuMjQxNTZDMS44ODgxIDEuNjAwMSAxLjYwMTU2IDEuODg2NjQgMS42MDE1NiAyLjI0MDFWNC45NjAxQzEuNjAxNTYgNS4zMTM1NiAxLjg4ODEgNS42MDAxIDIuMjQxNTYgNS42MDAxSDQuOTYxNTZDNS4zMTUwMiA1LjYwMDEgNS42MDE1NiA1LjMxMzU2IDUuNjAxNTYgNC45NjAxVjIuMjQwMUM1LjYwMTU2IDEuODg2NjQgNS4zMTUwMiAxLjYwMDEgNC45NjE1NiAxLjYwMDFaIiBmaWxsPSIjZmZmIi8%2BCjxwYXRoIGQ9Ik00Ljk2MTU2IDEwLjM5OTlIMi4yNDE1NkMxLjg4ODEgMTAuMzk5OSAxLjYwMTU2IDEwLjY4NjQgMS42MDE1NiAxMS4wMzk5VjEzLjc1OTlDMS42MDE1NiAxNC4xMTM0IDEuODg4MSAxNC4zOTk5IDIuMjQxNTYgMTQuMzk5OUg0Ljk2MTU2QzUuMzE1MDIgMTQuMzk5OSA1LjYwMTU2IDE0LjExMzQgNS42MDE1NiAxMy43NTk5VjExLjAzOTlDNS42MDE1NiAxMC42ODY0IDUuMzE1MDIgMTAuMzk5OSA0Ljk2MTU2IDEwLjM5OTlaIiBmaWxsPSIjZmZmIi8%2BCjxwYXRoIGQ9Ik0xMy43NTg0IDEuNjAwMUgxMS4wMzg0QzEwLjY4NSAxLjYwMDEgMTAuMzk4NCAxLjg4NjY0IDEwLjM5ODQgMi4yNDAxVjQuOTYwMUMxMC4zOTg0IDUuMzEzNTYgMTAuNjg1IDUuNjAwMSAxMS4wMzg0IDUuNjAwMUgxMy43NTg0QzE0LjExMTkgNS42MDAxIDE0LjM5ODQgNS4zMTM1NiAxNC4zOTg0IDQuOTYwMVYyLjI0MDFDMTQuMzk4NCAxLjg4NjY0IDE0LjExMTkgMS42MDAxIDEzLjc1ODQgMS42MDAxWiIgZmlsbD0iI2ZmZiIvPgo8cGF0aCBkPSJNNCAxMkwxMiA0TDQgMTJaIiBmaWxsPSIjZmZmIi8%2BCjxwYXRoIGQ9Ik00IDEyTDEyIDQiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLXdpZHRoPSIxLjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPgo8L3N2Zz4K&logoColor=ffffff)](https://zread.ai/whatevertogo/Timer)

ä¸€ä¸ªé«˜æ•ˆã€çµæ´»çš„è®¡æ—¶å™¨ç³»ç»Ÿå®ç°ï¼Œä¸“ä¸º Unity é¡¹ç›®è®¾è®¡ã€‚è¯¥ç³»ç»Ÿæä¾›äº†ç®€å•æ˜“ç”¨çš„ APIï¼Œç”¨äºç®¡ç†å’Œæ§åˆ¶å„ç§è®¡æ—¶ä»»åŠ¡ã€‚

## ç‰¹æ€§

- ğŸš€ **é«˜æ€§èƒ½å¯¹è±¡æ± å®ç°**ï¼Œå‡å°‘ GC å‹åŠ›
- ğŸ’¡ **æ”¯æŒå¤šç§è®¡æ—¶å™¨ç±»å‹**ï¼šä¸€æ¬¡æ€§ã€æœ‰é™é‡å¤ã€æ— é™é‡å¤ã€ä¸‹ä¸€å¸§å»¶è¿Ÿ
- ğŸ”„ **çµæ´»çš„å›è°ƒæœºåˆ¶**ï¼Œæ”¯æŒä¼ é€’ç”¨æˆ·æ•°æ®
- â± **æ—¶é—´æ§åˆ¶**ï¼šæ”¯æŒ TimeScale æ—¶é—´ç¼©æ”¾å’Œä¸å—ç¼©æ”¾å½±å“çš„ UnscaledTime
- ğŸ® **è®¡æ—¶å™¨æ§åˆ¶**ï¼šæ”¯æŒæš‚åœã€æ¢å¤ã€æ‰‹åŠ¨ç§»é™¤
- ğŸ›  **ç®€å•æ˜“ç”¨çš„ API æ¥å£**
- ğŸ¯ **å®Œæ•´çš„æ¥å£æŠ½è±¡**ï¼Œæ˜“äºæ‰©å±•å’Œæµ‹è¯•
- ğŸ“Š **è°ƒè¯•å‹å¥½**ï¼šç¼–è¾‘å™¨ä¸‹æ”¯æŒæŸ¥çœ‹æ´»è·ƒè®¡æ—¶å™¨ä¿¡æ¯

## å®‰è£…

å°† `Timer` æ–‡ä»¶å¤¹å¤åˆ¶åˆ°ä½ çš„ Unity é¡¹ç›®ä¸­å³å¯ä½¿ç”¨ã€‚

## å¿«é€Ÿå¼€å§‹

### åŸºç¡€ç”¨æ³•

```csharp
using Timer;

// ä¸€æ¬¡æ€§è®¡æ—¶å™¨ï¼š3ç§’åæ‰§è¡Œ
TimerSystemManager.Instance.AddOnce(3f, (data) => {
    Debug.Log("3ç§’åæ‰§è¡Œï¼");
});

// é‡å¤è®¡æ—¶å™¨ï¼šæ¯1ç§’æ‰§è¡Œä¸€æ¬¡ï¼Œå…±5æ¬¡
TimerSystemManager.Instance.AddRepeat(1f, 5, (data) => {
    Debug.Log("é‡å¤æ‰§è¡Œï¼");
});

// æ— é™é‡å¤è®¡æ—¶å™¨ï¼šæ¯0.5ç§’æ‰§è¡Œä¸€æ¬¡
var infiniteTimer = TimerSystemManager.Instance.AddRepeat(0.5f, (data) => {
    Debug.Log("æ— é™é‡å¤ï¼");
});
```

### é«˜çº§ç”¨æ³•

#### å¸¦æ§åˆ¶çš„è®¡æ—¶å™¨

```csharp
// åˆ›å»ºå¯æ§åˆ¶çš„è®¡æ—¶å™¨
var timer = TimerSystemManager.Instance.AddOnce(5f, (data) => {
    Debug.Log("5ç§’åæ‰§è¡Œ");
});

// æš‚åœè®¡æ—¶å™¨
timer.Pause();

// æ¢å¤è®¡æ—¶å™¨
timer.Resume();

// æ‰‹åŠ¨ç§»é™¤è®¡æ—¶å™¨
TimerSystemManager.Instance.RemoveTimer(timer);
```

#### ä¸å—æ—¶é—´ç¼©æ”¾å½±å“çš„è®¡æ—¶å™¨

```csharp
// å³ä½¿ä¿®æ”¹ Time.timeScaleï¼Œè®¡æ—¶å™¨ä»æŒ‰çœŸå®æ—¶é—´è¿è¡Œ
TimerSystemManager.Instance.AddOnce(
    3f,
    (data) => Debug.Log("ä¸å—æ—¶é—´ç¼©æ”¾å½±å“"),
    useUnscaledTime: true
);
```

#### ä¸‹ä¸€å¸§æ‰§è¡Œ

```csharp
// ä¸‹ä¸€å¸§æ‰§è¡Œå›è°ƒ
TimerSystemManager.Instance.AddNextFrame((data) => {
    Debug.Log("ä¸‹ä¸€å¸§æ‰§è¡Œ");
});
```

#### ä¼ é€’è‡ªå®šä¹‰æ•°æ®

```csharp
// é€šè¿‡ userData ä¼ é€’ä»»ä½•éœ€è¦çš„æ•°æ®
TimerSystemManager.Instance.AddOnce(2f, OnTimerComplete, "è‡ªå®šä¹‰æ•°æ®");

void OnTimerComplete(object userData)
{
    Debug.Log($"æ”¶åˆ°æ•°æ®ï¼š{userData}");
}
```

#### æ—¶é—´ç¼©æ”¾

```csharp
// è®¾ç½®æ—¶é—´ç¼©æ”¾ä¸º0.5ï¼ˆæ—¶é—´æµé€Ÿå‡åŠï¼‰
TimerSystemManager.Instance.TimeScale = 0.5f;

// æš‚åœæ‰€æœ‰å—æ—¶é—´ç¼©æ”¾å½±å“çš„è®¡æ—¶å™¨
TimerSystemManager.Instance.TimeScale = 0f;

// æ¢å¤æ­£å¸¸æ—¶é—´æµé€Ÿ
TimerSystemManager.Instance.TimeScale = 1f;
```

## API å‚è€ƒ

### ITimerSystem æ¥å£

| æ–¹æ³•/å±æ€§ | è¯´æ˜ |
|----------|------|
| `CreateTimer(interval, repeat, callback, userData, useUnscaledTime)` | åˆ›å»ºè®¡æ—¶å™¨ |
| `RemoveTimer(timer)` | ç§»é™¤è®¡æ—¶å™¨ |
| `FindTimer(callback)` | æ ¹æ®å›è°ƒæŸ¥æ‰¾è®¡æ—¶å™¨ï¼ˆå¤šä¸ªåŒå›è°ƒæ—¶è¿”å›æœ€åä¸€ä¸ªï¼‰ |
| `PauseTimer(callback)` | æš‚åœæŒ‡å®šå›è°ƒçš„è®¡æ—¶å™¨ |
| `ResumeTimer(callback)` | æ¢å¤æŒ‡å®šå›è°ƒçš„è®¡æ—¶å™¨ |
| `ClearAllTimers()` | æ¸…ç†æ‰€æœ‰è®¡æ—¶å™¨ |
| `ActiveTimerCount` | å½“å‰æ´»è·ƒè®¡æ—¶å™¨æ•°é‡ |
| `TimeScale` | æ—¶é—´ç¼©æ”¾ç³»æ•° |
| `Initialize()` | åˆå§‹åŒ–è®¡æ—¶å™¨ç³»ç»Ÿ |
| `Shutdown()` | å…³é—­è®¡æ—¶å™¨ç³»ç»Ÿ |

### ITimerEntity æ¥å£

| å±æ€§/æ–¹æ³• | è¯´æ˜ |
|----------|------|
| `IsRunning` | æ˜¯å¦æ­£åœ¨è¿è¡Œ |
| `UseUnscaledTime` | æ˜¯å¦ä½¿ç”¨éç¼©æ”¾æ—¶é—´ |
| `Interval` | é—´éš”æ—¶é—´ |
| `RemainingRepeatCount` | å‰©ä½™é‡å¤æ¬¡æ•°ï¼ˆ-1è¡¨ç¤ºæ— é™ï¼‰ |
| `Pause()` | æš‚åœè®¡æ—¶å™¨ |
| `Resume()` | æ¢å¤è®¡æ—¶å™¨ |
| `Reset()` | é‡ç½®è®¡æ—¶å™¨ |

### TimerExtensions æ‰©å±•æ–¹æ³•

| æ–¹æ³• | è¯´æ˜ |
|------|------|
| `AddOnce(seconds, callback, userData, useUnscaledTime)` | æ·»åŠ ä¸€æ¬¡æ€§è®¡æ—¶å™¨ |
| `AddRepeat(seconds, callback, userData, useUnscaledTime)` | æ·»åŠ æ— é™é‡å¤è®¡æ—¶å™¨ |
| `AddRepeat(seconds, repeatCount, callback, userData, useUnscaledTime)` | æ·»åŠ æœ‰é™æ¬¡æ•°é‡å¤è®¡æ—¶å™¨ |
| `AddNextFrame(callback, userData)` | æ·»åŠ å»¶è¿Ÿæ‰§è¡Œè®¡æ—¶å™¨ï¼ˆä¸‹ä¸€å¸§ï¼‰ |

## æ¶æ„è¯´æ˜

```
Timer/
â”œâ”€â”€ Interfaces/
â”‚   â”œâ”€â”€ ITimerSystem.cs          # è®¡æ—¶å™¨ç³»ç»Ÿæ¥å£
â”‚   â””â”€â”€ ITimerEntity.cs          # è®¡æ—¶å™¨å®ä½“æ¥å£
â”œâ”€â”€ TimerSystemManager.cs        # æ ¸å¿ƒç®¡ç†å™¨ï¼ˆå•ä¾‹ï¼‰
â”œâ”€â”€ TimerEntity.cs               # è®¡æ—¶å™¨å®ä½“å®ç°
â”œâ”€â”€ TimerObjectPool.cs           # å¯¹è±¡æ± å®ç°
â”œâ”€â”€ TimerExtensions.cs           # æ‰©å±•æ–¹æ³•
â”œâ”€â”€ TimerCallback.cs             # å›è°ƒå§”æ‰˜å®šä¹‰
â””â”€â”€ TimeExample/
    â””â”€â”€ TimeExample.cs           # ä½¿ç”¨ç¤ºä¾‹
```

### è®¾è®¡æ¨¡å¼

- **å•ä¾‹æ¨¡å¼**ï¼šTimerSystemManager ä½¿ç”¨å•ä¾‹ç¡®ä¿å…¨å±€å”¯ä¸€
- **å¯¹è±¡æ± æ¨¡å¼**ï¼šTimerObjectPool é‡ç”¨ TimerEntity å¯¹è±¡ï¼Œå‡å°‘ GC
- **æ¥å£éš”ç¦»**ï¼šITimerSystem å’Œ ITimerEntity æä¾›æ¸…æ™°çš„æŠ½è±¡
- **æ‰©å±•æ–¹æ³•æ¨¡å¼**ï¼šTimerExtensions æä¾›ä¾¿æ·çš„é“¾å¼ API

## æ€§èƒ½ä¼˜åŒ–

### å¯¹è±¡æ± æœºåˆ¶

ç³»ç»Ÿä½¿ç”¨å¯¹è±¡æ± æ¥ç®¡ç† `TimerEntity` å®ä¾‹ï¼š

```csharp
// åˆå§‹åŒ–æ—¶é¢„åˆ›å»º20ä¸ªå¯¹è±¡
_timerPool = new TimerObjectPool<TimerEntity>(20, timer => timer.Reset());
```

**ä¼˜åŠ¿**ï¼š
- å‡å°‘å†…å­˜åˆ†é…
- é™ä½åƒåœ¾å›æ”¶ï¼ˆGCï¼‰å‹åŠ›
- æå‡é¢‘ç¹åˆ›å»ºé”€æ¯åœºæ™¯ä¸‹çš„æ€§èƒ½

### Update ä¼˜åŒ–

ä½¿ç”¨ä¸¤é˜¶æ®µæ›´æ–°ç­–ç•¥ï¼Œé¿å…é¢‘ç¹çš„åˆ—è¡¨æ“ä½œï¼š
- **ç¬¬ä¸€é˜¶æ®µ**ï¼šéå†æ›´æ–°æ‰€æœ‰æ´»è·ƒè®¡æ—¶å™¨
- **ç¬¬äºŒé˜¶æ®µ**ï¼šæ‰¹é‡æ¸…ç†å·²åœæ­¢çš„è®¡æ—¶å™¨ï¼ˆä½¿ç”¨ `RemoveAll`ï¼‰

### æœ€ä½³å®è·µ

1. **åŠæ—¶æ¸…ç†**ï¼šåœ¨ `OnDestroy` ä¸­ç§»é™¤ä¸å†éœ€è¦çš„è®¡æ—¶å™¨
2. **ä¿å­˜å¼•ç”¨**ï¼šå¯¹äºéœ€è¦æ‰‹åŠ¨æ§åˆ¶çš„è®¡æ—¶å™¨ï¼Œä¿å­˜ `ITimerEntity` å¼•ç”¨
3. **åˆç†ä½¿ç”¨å¯¹è±¡æ± **ï¼šç³»ç»Ÿé»˜è®¤é¢„åˆ›å»º20ä¸ªå¯¹è±¡ï¼Œæ ¹æ®éœ€æ±‚è°ƒæ•´
4. **é€‰æ‹©åˆé€‚çš„æ—¶é—´æ¨¡å¼**ï¼šUIåŠ¨ç”»ä½¿ç”¨ `UnscaledTime`ï¼Œæ¸¸æˆé€»è¾‘ä½¿ç”¨å— `TimeScale` å½±å“çš„æ—¶é—´

## ç¤ºä¾‹

å®Œæ•´ç¤ºä¾‹è¯·æŸ¥çœ‹ `TimeExample/TimeExample.cs` æ–‡ä»¶ï¼ŒåŒ…å«ï¼š
- ä¸€æ¬¡æ€§è®¡æ—¶å™¨
- æœ‰é™/æ— é™é‡å¤è®¡æ—¶å™¨
- ä¸‹ä¸€å¸§å»¶è¿Ÿæ‰§è¡Œ
- ä¸å—æ—¶é—´ç¼©æ”¾å½±å“çš„è®¡æ—¶å™¨
- è®¡æ—¶å™¨çš„æš‚åœå’Œæ¢å¤

## å¸¸è§é—®é¢˜

### Q: è®¡æ—¶å™¨æ²¡æœ‰æ‰§è¡Œï¼Ÿ
A: ç¡®ä¿ `TimerSystemManager` å·²æ·»åŠ åˆ°åœºæ™¯ä¸­ï¼Œä¸” `Initialize()` å·²è¢«è°ƒç”¨ã€‚

### Q: å¦‚ä½•å–æ¶ˆä¸€ä¸ªè®¡æ—¶å™¨ï¼Ÿ
A: ä¿å­˜ `ITimerEntity` å¼•ç”¨ï¼Œè°ƒç”¨ `Pause()` æˆ–é€šè¿‡ `RemoveTimer()` ç§»é™¤ã€‚

### Q: TimeScale ä¸º 0 æ—¶ï¼ŒæŸäº›è®¡æ—¶å™¨ä»åœ¨è¿è¡Œï¼Ÿ
A: è¿™äº›è®¡æ—¶å™¨ä½¿ç”¨äº† `useUnscaledTime: true` å‚æ•°ï¼Œä¸å— TimeScale å½±å“ã€‚

### Q: ä¿®æ”¹ TimeScale åï¼Œå·²æœ‰çš„è®¡æ—¶å™¨ä¼šå—å½±å“å—ï¼Ÿ
A: åªæœ‰åˆ›å»ºæ—¶ `useUnscaledTime` ä¸º `false` çš„è®¡æ—¶å™¨ä¼šå—å½±å“ã€‚

### Q: å¦‚ä½•å®ç°å€’è®¡æ—¶åŠŸèƒ½ï¼Ÿ
A: ä½¿ç”¨é‡å¤è®¡æ—¶å™¨é…åˆé—­åŒ…å˜é‡å³å¯ï¼š
```csharp
float remainingTime = 10f;
TimerSystemManager.Instance.AddRepeat(0.1f, -1, data => {
    remainingTime -= Time.deltaTime;
    if (remainingTime > 0)
    {
        Debug.Log($"å‰©ä½™æ—¶é—´ï¼š{remainingTime:F1}ç§’");
    }
    else
    {
        Debug.Log("å€’è®¡æ—¶å®Œæˆ");
        // åœæ­¢è®¡æ—¶å™¨
    }
});
```

## ç³»ç»Ÿè¦æ±‚

- Unity 2020.3 æˆ–æ›´é«˜ç‰ˆæœ¬
- .NET Framework 4.x æˆ– .NET Standard 2.0+

## è®¸å¯è¯

æœ¬é¡¹ç›®éµå¾ª MIT è®¸å¯è¯ã€‚
